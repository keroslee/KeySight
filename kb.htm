<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>键盘按键统计</title>
	<style>
		html, body, div {
			margin: 0;
			padding: 0;
			font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
		}
		.tooltip {
			display: none;
			position: absolute;
			background-color: rgba(0, 0, 0, 0.7);
			color: white;
			padding: 5px;
			border-radius: 4px;
			font-size: 12px;
			z-index: 1000;
		}
		/* 容器 */
		.container {
			width: 100vw;
			height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: #000033;
		}

		/* 键盘 */
		.keyboard {
			display: flex;
			border-radius: 10px;
			box-shadow: 0px 0px 20px 1px #666 inset, 0px 0px 5px 1px #fff;
			background-color: #E4E6EA;
			padding: 20px;
		}

		/* 按键 */
		.key {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			width: 40px;
			height: 40px;
			border-radius: 8px;
			background-color: #E4E9EC;
			box-shadow: 3px 3px 8px 2px #999, -3px -3px 8px 2px #fff;
			color: #666;
			font-size: 13px;
			cursor: pointer;
			transition: .1s;
		}
		.key:hover, .active {
			box-shadow: 0 0 3px 1px #999;
		}

		/* 空键 */
		.key-empty {
			width: 40px;
			height: 40px;
		}

		/* 气泡键 */
		.key-bubble {
			display: flex;
			justify-content: center;
			align-items: center;
			border-radius: 10px;
			background-color: #009999;
			color: #fff;
			font-size: 13px;
			position: absolute;
			transition: all 2s ease-in-out;
			overflow: hidden;
			box-shadow: 0 0 10px 1px #000, 0 0 10px 1px #fff inset;
		}

		/* 区域一 */
		.area-1 {
			width: 740px;
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			align-content: baseline;
		}

		/* 区域二 */
		.area-2 {
			width: 140px;
			margin-left: 20px;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}
		.area-2-item {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		/* 区域三 */
		.area-3 {
			width: 190px;
			margin-left: 20px;
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		.area-3-light {
			display: flex;
			gap: 10px;
		}
		.area-3-light-item {
			width: 40px;
			height: 40px;
			line-height: 40px;
			text-align: center;
			color: #999;
		}
		.area-3-number {
			display: flex;
			gap: 10px;
		}
		.area-3-number-item {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		/* 最外层容器：键盘 + 鼠标 */
		#container {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 40px;
			flex-wrap: wrap;
		}

		/* 鼠标外壳 */
		#mouse-body {
			width: 120px;
			height: 200px;
			border: 2px solid black;
			position: relative;
			box-sizing: border-box;
			border-radius: 10px;
			box-shadow: 0px 0px 20px 1px #666 inset, 0px 0px 5px 1px #fff;
			background-color: #E4E6EA;
		}

		/* 顶部区域布局（鼠标左键/滚轮/右键） */
		#mouse-top {
			display: grid;
			grid-template-columns: 1fr 0.5fr 1fr;
			gap: 5px;
			padding: 8px;
		}

		/* 左右键 */
		.mouse-key {
			height: 60px;
			border: 3px solid black;
			border-radius: 6px;
		}

		/* 滚轮 */
		.mouse-wheel {
			height: 40px;
			border: 3px solid black;
			border-radius: 4px;
		}

		/* 左侧两个小键 */
		#mouse-side {
			display: flex;
			flex-direction: column;
			gap: 8px;

			position: absolute;
			left: -18px;
			top: 70px;
		}

		.mouse-key-small {
			width: 12px;
			height: 25px;
			border: 3px solid black;
			border-radius: 4px;
			background-color: #E4E6EA;
		}

		/* 响应式：窄屏时鼠标移动到键盘上方 */
		@media (max-width: 1330px) and (min-height: 570px) {
			#container {
				flex-direction: column;
				align-items: center;
				/* gap: 20px; */
			}
			#mouse-area {
				order: -1;
			}
		}
	</style>
</head>
<body>
	<div class="container" id="container">
		<div class="keyboard">
			<!-- 区域一 -->
			<div class="area-1">
				<!-- line1 -->
				<!-- <div class="key" id="k27" style="background-color: orange; color: #f5f5f5;">Esc</div> -->
				<div class="key" id="k27">Esc</div>
				<div class="key" id="k112" style="margin-left: 50px;">F1</div>
				<div class="key" id="k113">F2</div>
				<div class="key" id="k114">F3</div>
				<div class="key" id="k115" style="margin-right: 25px;">F4</div>
				<div class="key" id="k116">F5</div>
				<div class="key" id="k117">F6</div>
				<div class="key" id="k118">F7</div>
				<div class="key" id="k119" style="margin-right: 25px;">F8</div>
				<div class="key" id="k120">F9</div>
				<div class="key" id="k121">F10</div>
				<div class="key" id="k122">F11</div>
				<div class="key" id="k123">F12</div>
				<!-- line2 -->
				<div class="key" id="k192"><span>~</span><span>`</span></div>
				<div class="key" id="k49"><span>!</span><span>1</span></div>
				<div class="key" id="k50"><span>@</span><span>2</span></div>
				<div class="key" id="k51"><span>#</span><span>3</span></div>
				<div class="key" id="k52"><span>$</span><span>4</span></div>
				<div class="key" id="k53"><span>%</span><span>5</span></div>
				<div class="key" id="k54"><span>^</span><span>6</span></div>
				<div class="key" id="k55"><span>&</span><span>7</span></div>
				<div class="key" id="k56"><span>*</span><span>8</span></div>
				<div class="key" id="k57"><span>(</span><span>9</span></div>
				<div class="key" id="k48"><span>)</span><span>0</span></div>
				<div class="key" id="k189"><span>-</span><span>-</span></div>
				<div class="key" id="k187"><span>=</span><span>+</span></div>
				<div class="key" id="k8" style="width: 90px;">←</div>
				<!-- line3 -->
				<div class="key" id="k9" style="width: 70px;">Tab</div>
				<div class="key" id="k81">Q</div>
				<div class="key" id="k87">W</div>
				<div class="key" id="k69">E</div>
				<div class="key" id="k82">R</div>
				<div class="key" id="k84">T</div>
				<div class="key" id="k89">Y</div>
				<div class="key" id="k85">U</div>
				<div class="key" id="k73">I</div>
				<div class="key" id="k79">O</div>
				<div class="key" id="k80">P</div>
				<div class="key" id="k219"><span>[</span><span>{</span></div>
				<div class="key" id="k221"><span>]</span><span>}</span></div>
				<div class="key" id="k220" style="width: 60px;"><span>\</span><span>|</span></div>
				<!-- line4 -->
				<div class="key" id="k20" style="width: 85px;">Caps Lock</div>
				<div class="key" id="k65">A</div>
				<div class="key" id="k83">S</div>
				<div class="key" id="k68">D</div>
				<div class="key" id="k70">F</div>
				<div class="key" id="k71">G</div>
				<div class="key" id="k72">H</div>
				<div class="key" id="k74">J</div>
				<div class="key" id="k75">K</div>
				<div class="key" id="k76">L</div>
				<div class="key" id="k186"><span>;</span><span>:</span></div>
				<div class="key" id="k222"><span>'</span><span>"</span></div>
				<div class="key" id="k13" style="width: 95px;">Enter</div>
				<!-- line5 -->
				<div class="key" id="k16_left" style="width: 115px;">Shift</div>
				<div class="key" id="k90">Z</div>
				<div class="key" id="k88">X</div>
				<div class="key" id="k67">C</div>
				<div class="key" id="k86">V</div>
				<div class="key" id="k66">B</div>
				<div class="key" id="k78">N</div>
				<div class="key" id="k77">M</div>
				<div class="key" id="k188"><span>,</span><span><</span></div>
				<div class="key" id="k190"><span>.</span><span>></span></div>
				<div class="key" id="k191"><span>/</span><span>?</span></div>
				<div class="key" id="k16_right" style="width: 115px;">Shift</div>
				<!-- line6 -->
				<div class="key" id="k17_left" style="width: 50px;">Ctrl</div>
				<div class="key" id="k91" style="width: 50px;">Win</div>
				<div class="key" id="k18_left" style="width: 50px;">Alt</div>
				<div class="key" id="k32" style="width: 320px;"></div>
				<div class="key" id="k18_right" style="width: 50px;">Alt</div>
				<div class="key" id="k92" style="width: 50px;">Win</div>
				<div class="key" id="k93" style="width: 50px;">▤</div>
				<div class="key" id="k17_right" style="width: 50px;">Ctrl</div>
			</div>

			<!-- 区域二 -->
			<div class="area-2">
				<!-- 上 -->
				<div class="area-2-item">
					<div class="key" id="k44">Print</div>
					<div class="key" id="k145">Lock</div>
					<div class="key" id="k19">Pause</div>
					<div class="key" id="k45">Insert</div>
					<div class="key" id="k36">Home</div>
					<div class="key" id="k33">PgUp</div>
					<div class="key" id="k46">Del</div>
					<div class="key" id="k35">End</div>
					<div class="key" id="k34">PgDn</div>
				</div>
				<!-- 下 -->
				<div class="area-2-item">
					<div class="key-empty"></div>
					<div class="key" id="k38">↑</div>
					<div class="key-empty"></div>
					<div class="key" id="k37">←</div>
					<div class="key" id="k40">↓</div>
					<div class="key" id="k39">→</div>
				</div>
			</div>

			<!-- 区域三 -->
			<div class="area-3">
				<!-- 指示灯 -->
				<div class="area-3-light">
					<div class="area-3-light-item" style="color: orangered;">◘</div>
					<div class="area-3-light-item">◘</div>
					<div class="area-3-light-item">◘</div>
					<div class="area-3-light-item">◘</div>
				</div>
				<!-- 数字小键盘 -->
				<div class="area-3-number">
					<!-- 左 -->
					<div class="area-3-number-item">
						<div class="key" id="k144">Num</div>
						<div class="key" id="k111">/</div>
						<div class="key" id="k106">*</div>
						<div class="key" id="k103">7</div>
						<div class="key" id="k104">8</div>
						<div class="key" id="k105">9</div>
						<div class="key" id="k100">4</div>
						<div class="key" id="k101">5</div>
						<div class="key" id="k102">6</div>
						<div class="key" id="k97">1</div>
						<div class="key" id="k98">2</div>
						<div class="key" id="k99">3</div>
						<div class="key" id="k96" style="width: 90px;">0</div>
						<div class="key" id="k110">.</div>
					</div>
					<!-- 右 -->
					<div class="area-3-number-item">
						<div class="key" id="k109">-</div>
						<div class="key" id="k107" style="height: 90px;">+</div>
						<div class="key" id="k13_num" style="height: 90px;">Enter</div>
					</div>
				</div>
			</div>
		</div>

		<div id="mouse-area">
			<div id="mouse-body">

				<!-- 顶部：左键、滚轮、右键 -->
				<div id="mouse-top">
					<div class="mouse-key" id="k257"></div>
					<div class="mouse-wheel" id="k1279"></div>
					<div class="mouse-key" id="k263"></div>
				</div>

				<!-- 左侧两个额外按键 -->
				<div id="mouse-side">
					<div class="mouse-key-small" id="k383"></div>
					<div class="mouse-key-small" id="k767"></div>
				</div>

				<!-- 下部空白区域 -->
				<div id="mouse-bottom"></div>

			</div>
		</div>
		<div id="tooltip" class="tooltip"></div>
	</div>
	<script>
		// 获取按键选择器
		const getSelector = () => {
			let selector = ''
			// 区分 shift alt control 左右键
			if ([16, 17, 18].includes(event.keyCode)) {
				selector = `#k${event.keyCode}${event.code.endsWith('Left') ? '_left' : '_right'}`
			} else {
				// 区分 enter 键
				if (event.keyCode === 13 && event.code === 'NumpadEnter') {
					selector = `#k${event.keyCode}_num` // 数字小键盘中的 enter 键
				} else {
					selector = `#k${event.keyCode}`
				}
			}
			return selector
		}

		// 按下
		document.addEventListener('keydown', (event) => {
			console.log({event})
			const key = document.querySelector(getSelector())
			key && key.classList.add('active')
		})

		// 松开
		document.addEventListener('keyup', (event) => {
			const key = document.querySelector(getSelector())
			if (key) {
				handleMouseKeyAnimation(key,key.innerText/*event.key.toLocaleUpperCase()*/)
			}
		})
		// 获取鼠标按键的选择器
		function getMouseKeySelector(event) {
			var id='mouse-body'
			var key2id=['k257','k1279','k263','k767','k383']
			if (key2id[event.button]) id=key2id[event.button]
			return `#${id}`;
		}

		// 获取鼠标按键的显示文本
		function getMouseKeyText(event) {
			var txt='MB'
			var key2txt=['L','M','R','E1','E2']
			if (key2txt[event.button]) txt=key2txt[event.button]
			return txt
		}

		// 处理鼠标按键动画效果
		function handleMouseKeyAnimation(keyElement, keyText, direction=-1) {
			keyElement.classList.remove('active');
			
			const position = keyElement.getBoundingClientRect();
			const x = position.left;
			const y = position.top;
			const w = keyElement.offsetWidth;
			const h = keyElement.offsetHeight;

			const div = document.createElement('div');
			div.className = 'key-bubble';
			div.innerText = keyText;
			
			div.style.cssText = `
				position: fixed;
				left: ${x}px;
				top: ${y}px;
				opacity: .6;
				width: ${w}px;
				height: ${h}px;
			`;
			document.body.append(div);

			setTimeout(() => {
				div.style.cssText = `
					position: fixed;
					left: ${x}px;
					top: ${y + (direction<0?-500:500)}px;
					opacity: 0;
					width: ${w}px;
					height: ${h}px;
				`;
				setTimeout(() => div.remove(), 2050);
			}, 100);
		}

		// 鼠标按键按下事件 - 监听所有按键
		document.addEventListener('mousedown', (event) => {
			console.log('m key:',event.button)
			const mouseKey = getMouseKeySelector(event);
			const keyElement = document.querySelector(mouseKey);
			
			if (keyElement) {
				keyElement.classList.add('active');
			}
		});

		// 鼠标按键松开事件 - 监听所有按键
		document.addEventListener('mouseup', (event) => {
			const mouseKey = getMouseKeySelector(event);
			const keyElement = document.querySelector(mouseKey);
			
			if (keyElement) {
				const keyText = getMouseKeyText(event);
				handleMouseKeyAnimation(keyElement, keyText,event.button==3?1:-1);
			}
		});

		// 滚轮滚动事件
		document.addEventListener('wheel', (event) => {
			event.preventDefault();
			console.log('wheel:',event.button,event.deltaY)
			const wheelElement = document.querySelector('#k1279');
			if (wheelElement) {
				// 短暂高亮滚轮元素
				wheelElement.classList.add('active');
				
				// 根据滚动方向显示不同的文本
				const txt = event.deltaY > 0 ? 'D' : 'U'; // WD = Wheel Down, WU = Wheel Up
				handleMouseKeyAnimation(wheelElement, txt, event.deltaY);
				
				// 短暂延迟后移除高亮
				setTimeout(() => {
					wheelElement.classList.remove('active');
				}, 150);
			}
		}, { passive: false }); // 必须设置 passive: false 才能使用 preventDefault

		// 右键菜单阻止（避免干扰右键按键检测）
		document.addEventListener('contextmenu', (event) => {
			// 如果点击的是鼠标按键元素，阻止默认右键菜单
			const mouseKey = getMouseKeySelector(event);
			if (mouseKey && document.querySelector(mouseKey)) {
				event.preventDefault();
			}
		});
	</script>
	<script>
		// 获取按键选择器
		function getId(vk,flag){
			let selector = '';
			selector = `k${vk}`;
			if(vk == 160){
				selector = `k16_left`;
			} else if (vk==161){
				selector = `k16_right`;
			}else if (vk==162){
				selector = `k17_left`;
			}else if (vk==163){
				selector = `k17_right`;
			}else if (vk==164){
				selector = `k18_left`;
			}else if (vk==165){
				selector = `k18_right`;
			}
			return selector;
		}
		function generateRGBColors(value, maxValue) {
			// 定义起始颜色和结束颜色
			const startColor = [255, 255, 255]; // 红色 (RGB)
			const endColor = [255, 0, 0]; // 蓝色 (RGB)
			n = 20;
			index = value / maxValue*n;
			// 存储结果
			let colors = [];
			// 计算当前段的比例 (从 0 到 1)
			let ratio = index / n;
			// 对每个通道进行线性插值
			let r = Math.round(startColor[0] + ratio * (endColor[0] - startColor[0]));
			let g = Math.round(startColor[1] + ratio * (endColor[1] - startColor[1]));
			let b = Math.round(startColor[2] + ratio * (endColor[2] - startColor[2]));
			return `rgb(${r}, ${g}, ${b})`;
		}
		const tooltip = document.getElementById('tooltip');

		function isMouseKey(vk) {
			return vk > 255;
		}

		// 获取按键点击次数并设置热力图
		function fetchKeyCounts() {
			try {
				// 从 URL 获取 data 参数
				const params = new URLSearchParams(window.location.search);
				const dataStr = params.get("data");

				if (!dataStr) {
					console.warn("未提供 data 参数");
					return;
				}

				// 解析：id,count;id,count;...
				const keyCounts = dataStr.split(";")
					.filter(s => s.trim().length > 0)
					.map(pair => {
						const [idStr, countStr] = pair.split(",");
						return {
							virtual_key_code: Number(idStr),
							count: Number(countStr),
							key_name: "" // 没提供 name，可留空，你原代码不需要
						};
					});
				// 获取最大按键点击次数
				const keyboardItems = keyCounts.filter(k => !isMouseKey(k.virtual_key_code));
				const mouseItems = keyCounts.filter(k => isMouseKey(k.virtual_key_code));

				const maxKeyboard = keyboardItems.length ? Math.max(...keyboardItems.map(k => k.count)) : 1;
				const maxMouse = mouseItems.length ? Math.max(...mouseItems.map(k => k.count)) : 1;

				// 检查是否有小键盘区域的数据
				const numpadKeyCodes = [96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 144];
				const hasNumpadData = keyCounts.some(item => numpadKeyCodes.includes(item.virtual_key_code));

				// 如果没有小键盘数据，隐藏小键盘区域
				const numpadArea = document.querySelector('.area-3');
				if (!hasNumpadData && numpadArea) {
					numpadArea.style.display = 'none';
					adjustResponsiveBreakpoint();
				}

				keyCounts.forEach(item => {
					const id_ = getId(item.virtual_key_code,item.key_name);
					const keyElement = document.getElementById(id_);
					if (keyElement) {
						const count = item.count;
						if (isMouseKey(item.virtual_key_code)) {// 根据点击量改变键盘按键颜色
							keyElement.style.backgroundColor = generateRGBColors(count, maxMouse);
						} else {
							keyElement.style.backgroundColor = generateRGBColors(count, maxKeyboard);
						}
 
						keyElement.addEventListener('mouseover', function(event) {
							tooltip.textContent = `${item.count}`;
							tooltip.style.display = 'block';
							tooltip.style.left = event.pageX + 10 + 'px'; // Position tooltip next to mouse
							tooltip.style.top = event.pageY + 10 + 'px';
						});

						keyElement.addEventListener('mousemove', function(event) {
							tooltip.style.left = event.pageX + 10 + 'px'; // Update tooltip position
							tooltip.style.top = event.pageY + 10 + 'px';
						});

						keyElement.addEventListener('mouseout', function() {
							tooltip.style.display = 'none';
						});
					}
				});
			} catch (error) {
				console.error('Error fetching key counts:', error);
			}
		}

		// 动态调整响应式断点
		function adjustResponsiveBreakpoint() {
			// 获取键盘容器的实际宽度
			const keyboard = document.querySelector('.keyboard');
			const mouseArea = document.querySelector('#mouse-area');
			
			if (!keyboard || !mouseArea) return;
			
			const keyboardWidth = keyboard.offsetWidth;
			const mouseWidth = mouseArea.offsetWidth;
			const keyboardHeight = keyboard.offsetHeight;
			const mouseHeight = mouseArea.offsetHeight;
			
			// 计算新的断点：键盘宽度 + 鼠标宽度 + 一些额外边距
			const newBreakpointW = keyboardWidth + mouseWidth + 100;
			const newBreakpointH = keyboardHeight + mouseHeight + 40;
			
			console.log(`动态计算断点Width: ${newBreakpointW}px (键盘: ${keyboardWidth}px + 鼠标: ${mouseWidth}px)`);
			console.log(`动态计算断点Height: ${newBreakpointH}px (键盘: ${keyboardHeight}px + 鼠标: ${mouseHeight}px)`);
			
			// 直接修改现有媒体查询
			const styleSheets = document.styleSheets;
			for (let i = 0; i < styleSheets.length; i++) {
				try {
					const rules = styleSheets[i].cssRules || styleSheets[i].rules;
					for (let j = 0; j < rules.length; j++) {
						if (rules[j].type === 4 || rules[j].type === CSSRule.MEDIA_RULE) {
							// 找到原有的媒体查询并修改它
							rules[j].media.mediaText = rules[j].media.mediaText.replace(
								/max-width\s*:\s*([\d.]+)\s*(px|em|rem|vw|vh|%|cm|mm|in|pt|pc)/i,
								`max-width: ${newBreakpointW}px`
							);
							rules[j].media.mediaText = rules[j].media.mediaText.replace(
								/min-height\s*:\s*([\d.]+)\s*(px|em|rem|vw|vh|%|cm|mm|in|pt|pc)/i, 
								`min-height: ${newBreakpointH}px`
							);
							console.log(`已更新媒体查询断点为: ${newBreakpointW}px,${newBreakpointH}px`);
							return;
						}
					}
				} catch (e) {
					// 可能由于跨域限制无法访问某些样式表
					console.warn('无法访问某些样式表:', e);
				}
			}
			
			// 如果没有找到现有的媒体查询，创建一个新的
			createNewMediaQuery(newBreakpointW,newBreakpointH);
		}
		// 创建新的媒体查询
		function createNewMediaQuery(breakpointW,breakpointH) {
			let style = document.getElementById('dynamic-responsive-style');
			if (!style) {
				style = document.createElement('style');
				style.id = 'dynamic-responsive-style';
				document.head.appendChild(style);
			}
			// 设置新的媒体查询
			style.textContent = `
				@media (max-width: ${breakpointW}px) and (min-height: ${breakpointH}px) {
					#container {
						flex-direction: column;
						align-items: center;
					}
					#mouse-area {
						order: -1;
					}
				}
			`;
			console.log(`创建了新的媒体查询，断点为: ${breakpointW}px,${breakpointH}px`);
		}

		// 页面加载完成后调用
		window.addEventListener('load', function() {
			// 页面加载时处理数据
			fetchKeyCounts()
			// 确保在页面完全加载后计算宽度
			//setTimeout(adjustResponsiveBreakpoint, 100);
		});
	</script>
</body>
</html>